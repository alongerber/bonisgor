<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª | The Royal Court of Pettiness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .input-field {
            border-radius: 1rem;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #800000;
            box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.3);
            outline: none;
        }
        .supreme-judge-card {
            background: linear-gradient(145deg, #fcfcfc, #f5f5f5);
            border: 6px solid #800000;
            transition: all 0.2s ease;
            box-shadow: 0 10px 30px -5px rgba(128, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        #verdict-output {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 2.5rem 3rem;
            line-height: 1.8;
        }
        .context-btn {
            transition: all 0.2s ease;
        }
        .context-btn:hover {
            border-color: #800000;
            background-color: #fef2f2;
        }
        .context-btn.selected {
            background-color: #800000;
            color: white;
            border-color: #800000;
        }
        .gauge-container {
            position: relative;
            width: 180px;
            height: 100px;
            overflow: hidden;
        }
        .gauge-bg {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(from 180deg, #22c55e 0deg, #84cc16 30deg, #eab308 60deg, #f97316 90deg, #ef4444 120deg, #dc2626 150deg, #991b1b 180deg);
            clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%);
            transform: rotate(180deg);
        }
        .gauge-center {
            position: absolute;
            width: 140px;
            height: 140px;
            background: #ffffff;
            border-radius: 50%;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .gauge-needle {
            position: absolute;
            width: 4px;
            height: 70px;
            background: linear-gradient(to top, #1f2937 0%, #800000 100%);
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            border-radius: 2px;
            transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .gauge-needle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #1f2937;
            border: 3px solid #800000;
            border-radius: 50%;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }
        @media print {
            body > div:not(.printable-area) { display: none; }
            .printable-area { width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; background-color: white; }
            #verdict-output { display: block !important; padding: 1in; box-shadow: none; border: none; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl printable-area">
        
        <!-- ×¡×˜×˜×•×¡ ×‘×¨ -->
        <div id="statusBar" class="flex justify-between items-center mb-6 no-print">
            <div id="creditsDisplay" class="bg-gray-100 px-4 py-2 rounded-full border border-gray-200 flex items-center gap-2">
                <i data-lucide="coins" class="w-5 h-5 text-[#800000]"></i>
                <span class="text-sm font-medium text-gray-700">×§×¨×“×™×˜×™×: <span id="creditsCount" class="text-[#800000] font-bold">4/4</span></span>
            </div>
            <div id="authButtons">
                <button id="loginBtn" onclick="showAuthModal()" class="bg-[#800000] hover:bg-[#600000] text-white px-4 py-2 rounded-full text-sm font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="crown" class="w-4 h-4"></i>
                    ×”×ª×—×‘×¨×•×ª ×¤×¨×™××™×•×
                </button>
            </div>
            <div id="premiumBadge" class="hidden bg-gradient-to-r from-[#800000] to-[#a00000] text-white px-4 py-2 rounded-full flex items-center gap-2">
                <i data-lucide="crown" class="w-5 h-5"></i>
                <span class="font-bold">××©×ª××© ×¤×¨×™××™×•× ğŸ‘‘</span>
                <button onclick="handleSignOut()" class="mr-2 hover:text-gray-200 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- ×›×•×ª×¨×ª -->
        <div class="flex justify-center mb-4">
            <i data-lucide="scale" class="w-12 h-12 text-[#800000] border-b-2 border-[#800000] pb-2"></i>
        </div>
        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-[#800000] mb-2">×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª</h1>
            <p class="text-gray-500 text-lg">×”×’×™×©×• ××ª ×”×˜×¢× ×•×ª ×©×œ×›× ×‘×¤× ×™ ×”×©×•×¤×˜ ×”××œ×›×•×ª×™ ×•×§×‘×œ×• ×¤×¡×§ ×“×™×Ÿ ×¡×¨×§×¡×˜×™, ×¦×™×•×Ÿ ×§×˜× ×•× ×™×•×ª ×•×”×¢×•× ×© ×”×¨××•×™!</p>
        </header>

        <!-- ×›×¨×˜×™×¡ ×”×©×•×¤×˜ -->
        <div class="mb-8">
            <div class="supreme-judge-card p-8 rounded-xl text-center max-w-sm w-full mx-auto">
                <div class="flex justify-center items-center space-x-2 rtl:space-x-reverse mb-3">
                    <i data-lucide="book" class="w-8 h-8 text-[#800000]"></i>
                    <i data-lucide="gavel" class="w-10 h-10 text-[#800000]"></i>
                    <i data-lucide="book-open-check" class="w-8 h-8 text-[#800000]"></i>
                </div>
                <p class="text-xs font-medium text-[#800000] uppercase tracking-widest mb-1">×‘×¤× ×™ ×”×¨×›×‘ ×©×•×¤×˜×™ ×¢×œ</p>
                <p class="text-2xl font-extrabold text-[#333333] border-b border-gray-400 pb-2 mb-2">×‘×™×ª ×”×“×™×Ÿ ×”×¢×œ×™×•×Ÿ ×œ×§×˜× ×•× ×™×•×ª</p>
                <p class="text-sm text-gray-600 mt-3 italic">(×™×“×•×¢ ×‘×›×™× ×•×™×•: "×¤×¨×§×œ×™×˜×•×ª ×”×“×¨××”"). ×¤×•×¡×§ ×”×“×™×Ÿ ×”×‘×œ×ª×™ ××¢×•×¨×¢×¨.</p>
            </div>
        </div>

        <!-- ×‘×—×™×¨×ª ×”×§×©×¨ -->
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-700 mb-3 text-center">×”×§×©×¨ ×”×¡×›×¡×•×š:</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-2xl mx-auto">
                <button type="button" data-context="couple" class="context-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center">
                    <i data-lucide="heart" class="w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="text-sm font-medium text-gray-700">×–×•×’</span>
                </button>
                <button type="button" data-context="roommates" class="context-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center">
                    <i data-lucide="home" class="w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="text-sm font-medium text-gray-700">×©×•×ª×¤×™× ×œ×“×™×¨×”</span>
                </button>
                <button type="button" data-context="family" class="context-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center">
                    <i data-lucide="users" class="w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="text-sm font-medium text-gray-700">××©×¤×—×”</span>
                </button>
                <button type="button" data-context="work" class="context-btn selected bg-white border-2 border-gray-200 rounded-xl p-4 text-center">
                    <i data-lucide="briefcase" class="w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="text-sm font-medium text-gray-700">×¢×‘×•×“×”</span>
                </button>
            </div>
            <input type="hidden" id="selected-context" value="work">
        </div>

        <!-- ×˜×¢× ×•×ª -->
        <div class="mb-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="claim-a" class="block text-lg font-medium text-gray-700 mb-2 text-center flex items-center justify-center gap-2">
                        <span class="w-8 h-8 bg-[#800000] text-white rounded-full flex items-center justify-center text-sm font-bold">×</span>
                        ×˜×¢× ×ª ×¦×“ ××³
                    </label>
                    <textarea id="claim-a" rows="4" class="input-field w-full p-4 resize-none text-gray-800" placeholder="×ª××¨×• ××ª ×”×˜×¢× ×” ×©×œ ×¦×“ ××³..."></textarea>
                </div>
                <div>
                    <label for="claim-b" class="block text-lg font-medium text-gray-700 mb-2 text-center flex items-center justify-center gap-2">
                        <span class="w-8 h-8 bg-gray-600 text-white rounded-full flex items-center justify-center text-sm font-bold">×‘</span>
                        ×˜×¢× ×ª ×¦×“ ×‘×³
                    </label>
                    <textarea id="claim-b" rows="4" class="input-field w-full p-4 resize-none text-gray-800" placeholder="×ª××¨×• ××ª ×”×˜×¢× ×” ×©×œ ×¦×“ ×‘×³..."></textarea>
                </div>
            </div>
        </div>

        <!-- ×›×¤×ª×•×¨ ×©×œ×™×—×” -->
        <div class="text-center">
            <button id="judge-button" class="bg-[#800000] hover:bg-[#600000] text-white font-bold py-4 px-10 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed text-xl">
                <i data-lucide="gavel" class="w-6 h-6 inline-block ml-2"></i>
                <span id="button-text">×‘×§×©×• ×¤×¡×§ ×“×™×Ÿ!</span>
            </button>
        </div>

        <!-- ×˜×¢×™× ×” -->
        <div id="loading-area" class="mt-6 text-center hidden">
            <div class="inline-flex items-center gap-3 bg-gray-100 px-6 py-3 rounded-full">
                <i data-lucide="loader-2" class="w-6 h-6 text-[#800000] animate-spin"></i>
                <span class="text-[#800000] font-semibold">×”×©×•×¤×˜ ××ª×œ×‘×˜...</span>
            </div>
        </div>

        <!-- ×¤×œ×˜ ×¤×¡×§ ×”×“×™×Ÿ -->
        <div id="verdict-output" class="mt-10 hidden">
            <div class="text-center mb-8">
                <i data-lucide="shield-check" class="w-12 h-12 text-[#800000] mx-auto mb-2"></i>
                <p class="text-sm font-light text-gray-600">×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª</p>
                <h3 class="text-3xl font-extrabold text-gray-900 border-b-2 border-gray-400 inline-block px-4 pb-1 mt-1">×¤×¡×§ ×“×™×Ÿ ××œ×›×•×ª×™ - ×¨×©××™</h3>
            </div>

            <!-- ××“ ×§×˜× ×•× ×™×•×ª -->
            <div class="flex flex-col items-center mb-8">
                <p class="font-semibold text-gray-700 mb-2">××“ ×”×§×˜× ×•× ×™×•×ª</p>
                <div class="gauge-container">
                    <div class="gauge-bg"></div>
                    <div id="gaugeNeedle" class="gauge-needle"></div>
                    <div class="gauge-center">
                        <span id="scoreValue" class="text-3xl font-bold text-gray-900">0</span>
                        <span class="text-xs text-gray-500">××ª×•×š 100</span>
                    </div>
                </div>
                <div class="flex justify-between w-full max-w-[180px] text-xs text-gray-500 mt-1">
                    <span>×¡×‘×™×¨</span>
                    <span>×§×˜× ×•× ×™!</span>
                </div>
            </div>

            <!-- ×× ×¦×— -->
            <div id="winner-banner" class="bg-gradient-to-r from-gray-100 via-gray-200 to-gray-100 border-y-2 border-[#800000]/30 py-4 px-6 mb-6 text-center rounded-lg">
                <p class="text-sm text-gray-600 mb-1">×”×¦×“ ×”×¦×•×“×§:</p>
                <p id="winnerText" class="text-2xl font-bold text-[#800000]"></p>
            </div>

            <!-- ×¤×¡×§ ×“×™×Ÿ -->
            <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-[#800000]"></i>
                    × ×™××•×§×™ ×¤×¡×§ ×”×“×™×Ÿ
                </h3>
                <p id="verdictText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <!-- ×¢×•× ×© -->
            <div class="bg-red-50 rounded-xl p-6 border border-red-200">
                <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    ×”×¢×•× ×© ×©× ×’×–×¨
                </h3>
                <p id="punishmentText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <!-- ×—×ª×™××” -->
            <div class="mt-8 pt-4 border-t border-gray-300 text-sm text-gray-500 flex justify-between items-center flex-wrap gap-4">
                <span>×ª××¨×™×š: <span id="verdict-date"></span></span>
                <span>×—×ª×•× ×•×××•×©×¨ ×¢×œ ×™×“×™ ×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª</span>
            </div>

            <!-- ×›×¤×ª×•×¨×™ ×©×™×ª×•×£ -->
            <div class="flex flex-col sm:flex-row gap-3 mt-6 no-print">
                <button onclick="downloadAsImage()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    ×”×•×¨×“×” ×›×ª××•× ×”
                </button>
                <button onclick="shareToWhatsApp()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    ×©×™×ª×•×£ ×‘×•×•××˜×¡××¤
                </button>
                <button onclick="newVerdict()" class="flex-1 bg-[#800000] hover:bg-[#600000] text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    ×¡×›×¡×•×š ×—×“×©
                </button>
            </div>
        </div>

        <!-- ×¤×•×˜×¨ -->
        <footer class="text-center mt-12 text-gray-400 text-sm no-print">
            <p>×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×©×•× ×“×‘×¨ ×‘×¤×¨×˜</p>
            <p class="mt-1 text-xs">×¤×¡×§×™ ×”×“×™×Ÿ ×”× ×œ×¦×•×¨×š ×‘×™×“×•×¨ ×‘×œ×‘×“ ×•××™× × ××”×•×•×™× ×™×™×¢×•×¥ ××©×¤×˜×™ ×××™×ª×™</p>
        </footer>
    </div>

    <!-- ××•×“×œ ×”×ª×—×‘×¨×•×ª -->
    <div id="authModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <button onclick="closeAuthModal()" class="float-left text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="text-center mb-6 clear-both">
                <div class="w-16 h-16 bg-[#800000] rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="crown" class="w-8 h-8 text-white"></i></div>
                <h2 class="text-2xl font-bold text-gray-900">×”×¦×˜×¨×¤×• ×œ××¦×•×œ×”</h2>
                <p class="text-gray-500 text-sm mt-2">×”×ª×—×‘×¨×• ×œ×—×©×‘×•×Ÿ ×¤×¨×™××™×•× ×œ×©×™××•×© ×œ×œ× ×”×’×‘×œ×”</p>
            </div>
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button onclick="switchAuthTab('login')" id="loginTab" class="flex-1 py-2 rounded-md font-semibold text-sm transition-all bg-white text-gray-900 shadow">×”×ª×—×‘×¨×•×ª</button>
                <button onclick="switchAuthTab('register')" id="registerTab" class="flex-1 py-2 rounded-md font-semibold text-sm transition-all text-gray-500">×”×¨×©××”</button>
            </div>
            <button onclick="signInWithGoogle()" class="w-full bg-white border-2 border-gray-200 rounded-xl py-3 font-semibold text-gray-700 flex items-center justify-center gap-3 hover:border-[#800000] transition-all mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                ×”××©×š ×¢× Google
            </button>
            <div class="flex items-center gap-4 my-4"><div class="h-px flex-1 bg-gray-200"></div><span class="text-gray-400 text-sm">××•</span><div class="h-px flex-1 bg-gray-200"></div></div>
            <form id="emailAuthForm" onsubmit="handleEmailAuth(event)" class="space-y-4">
                <input type="email" id="authEmail" placeholder="××™××™×™×œ" class="input-field w-full p-3 text-gray-800" required>
                <input type="password" id="authPassword" placeholder="×¡×™×¡××”" class="input-field w-full p-3 text-gray-800" required minlength="6">
                <button type="submit" class="w-full bg-[#800000] hover:bg-[#600000] text-white py-3 rounded-xl font-semibold"><span id="authSubmitText">×”×ª×—×‘×¨×•×ª</span></button>
            </form>
            <p id="authError" class="hidden mt-4 text-center text-red-600 text-sm"></p>
        </div>
    </div>

    <!-- ××•×“×œ ×©×“×¨×•×’ -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center">
            <button onclick="closeUpgradeModal()" class="float-left text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="clear-both">
                <div class="w-24 h-24 bg-[#800000] rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="crown" class="w-12 h-12 text-white"></i></div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">× ×’××¨×• ×”×§×¨×“×™×˜×™×!</h2>
                <p class="text-gray-500 mb-6">×”×©×ª××©×ª ×‘-4 ×¤×¡×§×™ ×”×“×™×Ÿ ×”×—×™× ××™×™× ×©×œ×š</p>
                <div class="bg-gray-100 rounded-xl p-4 mb-6 text-right">
                    <p class="font-semibold text-gray-800 mb-2 text-center">××©×ª××©×™× ×¤×¨×™××™×•× × ×”× ×™× ×:</p>
                    <ul class="text-gray-600 text-sm space-y-2">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-600"></i>×¤×¡×§×™ ×“×™×Ÿ ×œ×œ× ×”×’×‘×œ×”</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-600"></i>×’×™×©×” ×œ×›×œ ×¡×•×’×™ ×”×¡×›×¡×•×›×™×</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-600"></i>×ª××™×›×” ××œ×›×•×ª×™×ª 24/7</li>
                    </ul>
                </div>
                <button onclick="closeUpgradeModal(); showAuthModal();" class="w-full bg-[#800000] hover:bg-[#600000] text-white py-4 rounded-xl font-bold text-lg">×”×¨×©××• ×¢×›×©×™×• - ×—×™× ×!</button>
                <p class="mt-4 text-gray-400 text-xs">×”×”×¨×©××” ×—×™× ××™×ª ×œ×—×œ×•×˜×™×Ÿ</p>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×©×’×™××” -->
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-circle" class="w-8 h-8 text-red-600"></i></div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">××•×¤×¡! ××©×”×• ×”×©×ª×‘×©</h2>
            <p id="errorMessage" class="text-gray-500 mb-6">××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×¢×™×‘×•×“ ×”×‘×§×©×”</p>
            <button onclick="closeErrorModal()" class="bg-[#800000] hover:bg-[#600000] text-white px-8 py-3 rounded-xl font-semibold">×”×‘× ×ª×™</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDRR-PMlAz_hVzLQJ4jl37F3QDa_pxS830",
            authDomain: "royal-court-pettiness.firebaseapp.com",
            projectId: "royal-court-pettiness",
            storageBucket: "royal-court-pettiness.firebasestorage.app",
            messagingSenderId: "570213664438",
            appId: "1:570213664438:web:79a460121596a491c2c817"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseGoogleProvider = googleProvider;
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseIncrement = increment;

        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        const GEMINI_API_KEY = 'AIzaSyAzks62M8qyLefTZ2ovuPGmItfP26GcLIk';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        let currentUser = null;
        let userCredits = 4;
        let isPremium = false;
        let isAuthTabLogin = true;
        let lastVerdict = null;
        let selectedContext = 'work';

        const contextLabels = { couple: '×–×•×’', roommates: '×©×•×ª×¤×™× ×œ×“×™×¨×”', family: '××©×¤×—×”', work: '×¢×‘×•×“×”' };

        window.addEventListener('firebase-ready', initializeApp);

        function initializeApp() {
            lucide.createIcons();
            firebaseOnAuthStateChanged(firebaseAuth, handleAuthStateChange);
            setupContextButtons();
            setupJudgeButton();
        }

        function setupContextButtons() {
            document.querySelectorAll('.context-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.context-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.querySelector('span').classList.remove('text-white');
                        b.querySelector('span').classList.add('text-gray-700');
                        b.querySelector('i').classList.remove('text-white');
                        b.querySelector('i').classList.add('text-[#800000]');
                    });
                    btn.classList.add('selected');
                    btn.querySelector('span').classList.add('text-white');
                    btn.querySelector('span').classList.remove('text-gray-700');
                    btn.querySelector('i').classList.add('text-white');
                    btn.querySelector('i').classList.remove('text-[#800000]');
                    selectedContext = btn.dataset.context;
                    document.getElementById('selected-context').value = selectedContext;
                });
            });
        }

        function setupJudgeButton() {
            document.getElementById('judge-button').addEventListener('click', handleJudgeClick);
        }

        async function handleAuthStateChange(user) {
            currentUser = user;
            if (user) {
                isPremium = !user.isAnonymous;
                if (isPremium) { showPremiumUI(); } else { await checkUsageLimits(user.uid); showFreeUI(); }
            } else {
                try { await firebaseSignInAnonymously(firebaseAuth); } catch (error) { console.error('Anonymous sign-in error:', error); showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª'); }
            }
        }

        async function checkUsageLimits(uid) {
            try {
                const userLimitRef = firebaseDoc(firebaseDb, 'user_limits', uid);
                const docSnap = await firebaseGetDoc(userLimitRef);
                if (docSnap.exists()) { userCredits = 4 - (docSnap.data().count || 0); if (userCredits < 0) userCredits = 0; } else { await firebaseSetDoc(userLimitRef, { count: 0 }); userCredits = 4; }
                updateCreditsDisplay();
            } catch (error) { console.error('Error checking usage limits:', error); userCredits = 4; updateCreditsDisplay(); }
        }

        async function incrementUsage(uid) {
            try {
                const userLimitRef = firebaseDoc(firebaseDb, 'user_limits', uid);
                await firebaseUpdateDoc(userLimitRef, { count: firebaseIncrement(1) });
                userCredits--;
                updateCreditsDisplay();
            } catch (error) { console.error('Error incrementing usage:', error); }
        }

        function showPremiumUI() {
            document.getElementById('creditsDisplay').classList.add('hidden');
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('premiumBadge').classList.remove('hidden');
            lucide.createIcons();
        }

        function showFreeUI() {
            document.getElementById('creditsDisplay').classList.remove('hidden');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('premiumBadge').classList.add('hidden');
            updateCreditsDisplay();
            lucide.createIcons();
        }

        function updateCreditsDisplay() {
            const c = document.getElementById('creditsCount');
            c.textContent = `${userCredits}/4`;
            if (userCredits <= 1) { c.classList.add('text-red-600'); c.classList.remove('text-[#800000]'); } else { c.classList.remove('text-red-600'); c.classList.add('text-[#800000]'); }
        }

        async function handleJudgeClick() {
            if (!isPremium && userCredits <= 0) { showUpgradeModal(); return; }

            const sideA = document.getElementById('claim-a').value.trim();
            const sideB = document.getElementById('claim-b').value.trim();

            if (!sideA || !sideB || sideA.length < 10 || sideB.length < 10) { showError('× × ×œ××œ× ××ª ×©× ×™ ×”×¦×“×“×™× ×©×œ ×”×¡×›×¡×•×š (×œ×¤×—×•×ª 10 ×ª×•×•×™×)'); return; }

            showLoading(true);

            try {
                const verdict = await getVerdict(selectedContext, sideA, sideB);
                if (!isPremium && currentUser) { await incrementUsage(currentUser.uid); }
                displayVerdict(verdict);
            } catch (error) { console.error('Error getting verdict:', error); showError('×”×©×•×¤×˜ × ×ª×§×œ ×‘×‘×¢×™×” ×˜×›× ×™×ª. × ×¡×• ×©×•×‘.'); } finally { showLoading(false); }
        }

        async function getVerdict(context, sideA, sideB) {
            const contextHebrew = contextLabels[context] || '×›×œ×œ×™';
            const prompt = `××ª×” ×©×•×¤×˜ ××œ×›×•×ª×™ ×¡×¨×§×¡×˜×™ ×•××¦×—×™×§ ×‘×‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª. ×ª×¤×§×™×“×š ×œ×©×¤×•×˜ ×¡×›×¡×•×›×™× ×§×˜× ×•× ×™×™× ×‘×™×Ÿ ×× ×©×™× ×‘×¦×•×¨×” ×”×•××•×¨×™×¡×˜×™×ª.

×”×§×©×¨ ×”×¡×›×¡×•×š: ${contextHebrew}

×˜×¢× ×ª ×¦×“ ×':
${sideA}

×˜×¢× ×ª ×¦×“ ×‘':
${sideB}

×¢×œ×™×š ×œ×”×—×–×™×¨ ×ª×©×•×‘×” ×‘×¤×•×¨××˜ JSON ×‘×œ×‘×“ (×œ×œ× markdown, ×œ×œ× backticks, ×¨×§ JSON ×˜×”×•×¨) ×¢× ×”××‘× ×” ×”×‘×:
{
    "winner": "×¦×“ ×" ××• "×¦×“ ×‘" ××• "×©× ×™×”× ×¦×•×“×§×™×" ××• "×©× ×™×”× ×˜×•×¢×™×",
    "pettyScore": ××¡×¤×¨ ×‘×™×Ÿ 0 ×œ-100 ×©××™×™×¦×’ ×›××” ×§×˜× ×•× ×™ ×”×¡×›×¡×•×š ×”×–×” (100 = ×§×˜× ×•× ×™ ×‘×™×•×ª×¨),
    "verdict": "×¤×¡×§ ×“×™×Ÿ ×¡×¨×§×¡×˜×™ ×•××¦×—×™×§ ×‘×¢×‘×¨×™×ª (3-5 ××©×¤×˜×™×) ×©××¡×‘×™×¨ ××™ ×¦×•×“×§ ×•×œ××”",
    "punishment": "×¢×•× ×© ×™×¦×™×¨×ª×™ ×•××¦×—×™×§ ×œ×¦×“ ×©×”×¤×¡×™×“ ××• ×œ×©× ×™ ×”×¦×“×“×™× (2-3 ××©×¤×˜×™×)"
}

×—×©×•×‘:
- ×”×™×” ×¡×¨×§×¡×˜×™ ×•××¦×—×™×§ ××‘×œ ×œ× ×¤×•×’×¢× ×™
- ×”×ª×™×™×—×¡ ×œ×¤×¨×˜×™× ×”×¡×¤×¦×™×¤×™×™× ××”×˜×¢× ×•×ª
- ×”×¢×•× ×© ×¦×¨×™×š ×œ×”×™×•×ª ×™×¦×™×¨×ª×™ ×•××ª××™× ×œ×¡×™×˜×•××¦×™×”
- ×”×¦×™×•×Ÿ ×¦×¨×™×š ×œ×©×§×£ ×›××” ×”×¡×›×¡×•×š ×‘×××ª ×§×˜× ×•× ×™ ×•××’×•×—×š`;

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.9, maxOutputTokens: 1024 } })
            });

            if (!response.ok) { throw new Error('API request failed'); }

            const data = await response.json();
            let jsonStr = data.candidates[0].content.parts[0].text.trim();
            if (jsonStr.startsWith('```')) { jsonStr = jsonStr.replace(/```json?\n?/g, '').replace(/```/g, ''); }
            return JSON.parse(jsonStr);
        }

        function displayVerdict(verdict) {
            lastVerdict = verdict;
            document.getElementById('verdict-output').classList.remove('hidden');
            document.getElementById('winnerText').textContent = verdict.winner;
            document.getElementById('verdictText').textContent = verdict.verdict;
            document.getElementById('punishmentText').textContent = verdict.punishment;
            document.getElementById('verdict-date').textContent = new Date().toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            setTimeout(() => { animateGauge(verdict.pettyScore); }, 300);
            lucide.createIcons();
            document.getElementById('verdict-output').scrollIntoView({ behavior: 'smooth' });
        }

        function animateGauge(score) {
            const needle = document.getElementById('gaugeNeedle');
            const scoreValue = document.getElementById('scoreValue');
            const rotation = -90 + (score * 1.8);
            needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            let currentScore = 0;
            const duration = 1500;
            const startTime = Date.now();
            function updateScore() { const elapsed = Date.now() - startTime; const progress = Math.min(elapsed / duration, 1); const easeOut = 1 - Math.pow(1 - progress, 3); currentScore = Math.round(score * easeOut); scoreValue.textContent = currentScore; if (progress < 1) { requestAnimationFrame(updateScore); } }
            updateScore();
        }

        function showLoading(show) {
            const l = document.getElementById('loading-area');
            const b = document.getElementById('judge-button');
            if (show) { l.classList.remove('hidden'); b.disabled = true; } else { l.classList.add('hidden'); b.disabled = false; }
        }

        window.newVerdict = function() {
            document.getElementById('claim-a').value = '';
            document.getElementById('claim-b').value = '';
            document.getElementById('verdict-output').classList.add('hidden');
            document.getElementById('gaugeNeedle').style.transform = 'translateX(-50%) rotate(-90deg)';
            document.getElementById('scoreValue').textContent = '0';
            lastVerdict = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.downloadAsImage = async function() {
            try {
                const canvas = await html2canvas(document.getElementById('verdict-output'), { backgroundColor: '#ffffff', scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = '×¤×¡×§-×“×™×Ÿ-×§×˜× ×•× ×™.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) { console.error('Error creating image:', error); showError('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª××•× ×”'); }
        }

        window.shareToWhatsApp = function() {
            if (!lastVerdict) return;
            const text = `ğŸ›ï¸ *×¤×¡×§ ×“×™×Ÿ ××‘×™×ª ×”×“×™×Ÿ ×œ×§×˜× ×•× ×™×•×ª* ğŸ›ï¸\n\nâš–ï¸ ×”×›×¨×¢×”: ${lastVerdict.winner}\nğŸ“Š ×¦×™×•×Ÿ ×§×˜× ×•× ×™×•×ª: ${lastVerdict.pettyScore}/100\n\nğŸ“œ ×¤×¡×§ ×”×“×™×Ÿ:\n${lastVerdict.verdict}\n\nâš ï¸ ×”×¢×•× ×©:\n${lastVerdict.punishment}\n\n---\nğŸ”— ×©×¤×˜×• ×’× ××ª×: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        window.showAuthModal = function() { document.getElementById('authModal').classList.remove('hidden'); lucide.createIcons(); }
        window.closeAuthModal = function() { document.getElementById('authModal').classList.add('hidden'); document.getElementById('authError').classList.add('hidden'); document.getElementById('emailAuthForm').reset(); }

        window.switchAuthTab = function(tab) {
            isAuthTabLogin = tab === 'login';
            const l = document.getElementById('loginTab');
            const r = document.getElementById('registerTab');
            const t = document.getElementById('authSubmitText');
            if (isAuthTabLogin) { l.classList.add('bg-white', 'text-gray-900', 'shadow'); l.classList.remove('text-gray-500'); r.classList.remove('bg-white', 'text-gray-900', 'shadow'); r.classList.add('text-gray-500'); t.textContent = '×”×ª×—×‘×¨×•×ª'; } else { r.classList.add('bg-white', 'text-gray-900', 'shadow'); r.classList.remove('text-gray-500'); l.classList.remove('bg-white', 'text-gray-900', 'shadow'); l.classList.add('text-gray-500'); t.textContent = '×”×¨×©××”'; }
        }

        window.signInWithGoogle = async function() { try { await firebaseSignInWithPopup(firebaseAuth, firebaseGoogleProvider); closeAuthModal(); } catch (error) { console.error('Google sign-in error:', error); showAuthError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× Google'); } }

        window.handleEmailAuth = async function(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            try { if (isAuthTabLogin) { await firebaseSignInWithEmailAndPassword(firebaseAuth, email, password); } else { await firebaseCreateUserWithEmailAndPassword(firebaseAuth, email, password); } closeAuthModal(); } catch (error) { console.error('Email auth error:', error); let msg = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª'; switch (error.code) { case 'auth/invalid-email': msg = '×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×ª×§×™× ×”'; break; case 'auth/user-not-found': msg = '××©×ª××© ×œ× × ××¦×'; break; case 'auth/wrong-password': msg = '×¡×™×¡××” ×©×’×•×™×”'; break; case 'auth/email-already-in-use': msg = '×”××™××™×™×œ ×›×‘×¨ ×‘×©×™××•×©'; break; case 'auth/weak-password': msg = '×”×¡×™×¡××” ×—×œ×©×” ××“×™'; break; case 'auth/invalid-credential': msg = '×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×©×’×•×™×™×'; break; } showAuthError(msg); }
        }

        function showAuthError(message) { const e = document.getElementById('authError'); e.textContent = message; e.classList.remove('hidden'); }

        window.handleSignOut = async function() { try { await firebaseSignOut(firebaseAuth); } catch (error) { console.error('Sign out error:', error); } }

        window.showUpgradeModal = function() { document.getElementById('upgradeModal').classList.remove('hidden'); lucide.createIcons(); }
        window.closeUpgradeModal = function() { document.getElementById('upgradeModal').classList.add('hidden'); }

        function showError(message) { document.getElementById('errorMessage').textContent = message; document.getElementById('errorModal').classList.remove('hidden'); lucide.createIcons(); }
        window.closeErrorModal = function() { document.getElementById('errorModal').classList.add('hidden'); }

        ['authModal', 'upgradeModal', 'errorModal'].forEach(id => { document.getElementById(id).addEventListener('click', (e) => { if (e.target.id === id) { document.getElementById(id).classList.add('hidden'); } }); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeAuthModal(); closeUpgradeModal(); closeErrorModal(); } });
    </script>
</body>
</html>
