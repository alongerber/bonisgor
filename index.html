<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 住专 转 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; color: #1f2937; }
        .input-field { border-radius: 1rem; border: 2px solid #e5e7eb; transition: all 0.3s ease; }
        .input-field:focus { border-color: #800000; box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.3); outline: none; }
        .judge-card { background: linear-gradient(145deg, #fcfcfc, #f5f5f5); border: 6px solid #800000; box-shadow: 0 10px 30px -5px rgba(128, 0, 0, 0.4); }
        .context-btn { transition: all 0.2s ease; background: white; border: 2px solid #e5e7eb; cursor: pointer; }
        .context-btn:hover { border-color: #800000; background-color: #fef7f7; }
        .context-btn.selected { background-color: #800000 !important; border-color: #800000 !important; }
        .context-btn.selected .ctx-icon { color: white !important; }
        .context-btn.selected .ctx-text { color: white !important; }
        .gauge-container { position: relative; width: 180px; height: 100px; overflow: hidden; }
        .gauge-bg { position: absolute; width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(from 180deg, #22c55e 0deg, #84cc16 30deg, #eab308 60deg, #f97316 90deg, #ef4444 120deg, #dc2626 150deg, #991b1b 180deg); clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%); transform: rotate(180deg); }
        .gauge-center { position: absolute; width: 140px; height: 140px; background: #ffffff; border-radius: 50%; top: 20px; left: 20px; display: flex; align-items: center; justify-content: center; flex-direction: column; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .gauge-needle { position: absolute; width: 4px; height: 70px; background: linear-gradient(to top, #1f2937 0%, #800000 100%); bottom: 0; left: 50%; transform-origin: bottom center; transform: translateX(-50%) rotate(-90deg); border-radius: 2px; transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .gauge-needle::after { content: ''; position: absolute; width: 16px; height: 16px; background: #1f2937; border: 3px solid #800000; border-radius: 50%; bottom: -8px; left: 50%; transform: translateX(-50%); }
        .modal-overlay { background: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">

        <!-- 住住 专 -->
        <div id="statusBar" class="flex justify-between items-center mb-6">
            <div id="creditsDisplay" class="bg-gray-100 px-4 py-2 rounded-full border border-gray-200 flex items-center gap-2">
                <i data-lucide="coins" class="w-5 h-5 text-amber-600"></i>
                <span class="text-sm font-medium text-gray-700">拽专: <span id="creditsCount" class="text-amber-600 font-bold">4/4</span></span>
            </div>
            <div id="authButtons">
                <button id="loginBtn" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-full text-sm font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="crown" class="w-4 h-4"></i>
                    转专转 驻专
                </button>
            </div>
            <div id="premiumBadge" class="hidden bg-gradient-to-r from-amber-500 to-amber-600 text-white px-4 py-2 rounded-full flex items-center gap-2">
                <i data-lucide="crown" class="w-5 h-5"></i>
                <span class="font-bold">砖转砖 驻专 </span>
                <button id="signOutBtn" class="mr-2 hover:text-gray-200 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- 转专转 -->
        <div class="flex justify-center mb-4">
            <i data-lucide="scale" class="w-12 h-12 text-[#800000]"></i>
        </div>
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-[#800000] mb-2"> 住专 转 </h1>
            <p class="text-gray-500 text-lg">专专 专  拽 -  转 住住 拽 驻住拽  爪祝!</p>
        </header>

        <!-- 专住 砖驻 -->
        <div class="mb-8">
            <div class="judge-card p-6 rounded-xl text-center max-w-md w-full mx-auto">
                <div class="flex justify-center items-center gap-2 mb-3">
                    <i data-lucide="gavel" class="w-10 h-10 text-[#800000]"></i>
                </div>
                <p class="text-xs font-medium text-[#800000] uppercase tracking-widest mb-1">驻 专 砖驻 注</p>
                <p class="text-xl font-extrabold text-gray-800 border-b border-gray-300 pb-2 mb-2">转  注: 注 专</p>
                <p class="text-sm text-gray-600 italic">(注 : "驻专拽转 拽转")</p>
            </div>
        </div>

        <!-- 专转 拽砖专 -->
        <div class="mb-6">
            <label class="block text-lg font-semibold text-gray-700 mb-3 text-center">拽砖专 住住:</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-2xl mx-auto" id="contextButtons">
                <button type="button" data-context="couple" class="context-btn rounded-xl p-4 text-center">
                    <i data-lucide="heart" class="ctx-icon w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="ctx-text text-sm font-medium text-gray-700 block"></span>
                </button>
                <button type="button" data-context="roommates" class="context-btn rounded-xl p-4 text-center">
                    <i data-lucide="home" class="ctx-icon w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="ctx-text text-sm font-medium text-gray-700 block">砖转驻 专</span>
                </button>
                <button type="button" data-context="family" class="context-btn rounded-xl p-4 text-center">
                    <i data-lucide="users" class="ctx-icon w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="ctx-text text-sm font-medium text-gray-700 block">砖驻</span>
                </button>
                <button type="button" data-context="work" class="context-btn selected rounded-xl p-4 text-center">
                    <i data-lucide="briefcase" class="ctx-icon w-6 h-6 mx-auto mb-2 text-[#800000]"></i>
                    <span class="ctx-text text-sm font-medium text-gray-700 block">注</span>
                </button>
            </div>
        </div>

        <!-- 注转 -->
        <div class="mb-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 bg-[#800000] text-white rounded-full text-sm font-bold ml-2"></span>
                        注转 爪 壮
                    </label>
                    <textarea id="claim-a" rows="4" class="input-field w-full p-4 resize-none text-gray-800" placeholder="砖: ' 专 砖专 注  专  砖 注 砖砖 '"></textarea>
                </div>
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 bg-gray-500 text-white rounded-full text-sm font-bold ml-2"></span>
                        注转 爪 壮
                    </label>
                    <textarea id="claim-b" rows="4" class="input-field w-full p-4 resize-none text-gray-800" placeholder="砖: ' 砖专 专   专 砖注'"></textarea>
                </div>
            </div>
        </div>

        <!-- 驻转专 砖 -->
        <div class="text-center">
            <button id="judge-button" class="bg-[#800000] hover:bg-[#600000] text-white font-bold py-4 px-10 rounded-full shadow-lg transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed text-xl">
                <i data-lucide="gavel" class="w-6 h-6 inline-block ml-2"></i>
                拽 驻住拽 !
            </button>
        </div>

        <!-- 注 -->
        <div id="loading-area" class="mt-6 text-center hidden">
            <div class="inline-flex items-center gap-3 bg-amber-50 px-6 py-3 rounded-full border border-amber-200">
                <svg class="animate-spin h-6 w-6 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-amber-700 font-semibold">砖驻 转...</span>
            </div>
        </div>

        <!-- 驻 驻住拽  -->
        <div id="verdict-output" class="mt-10 hidden bg-white border border-gray-200 rounded-2xl p-8 shadow-lg">
            <div class="text-center mb-8">
                <i data-lucide="shield-check" class="w-12 h-12 text-[#800000] mx-auto mb-2"></i>
                <h3 class="text-3xl font-extrabold text-gray-900">驻住拽  专注 - 专砖</h3>
            </div>

            <!--  拽转 -->
            <div class="flex flex-col items-center mb-8">
                <p class="font-semibold text-gray-700 mb-2"> 拽转</p>
                <div class="gauge-container">
                    <div class="gauge-bg"></div>
                    <div id="gaugeNeedle" class="gauge-needle"></div>
                    <div class="gauge-center">
                        <span id="scoreValue" class="text-3xl font-bold text-gray-900">0</span>
                        <span class="text-xs text-gray-500">转 100</span>
                    </div>
                </div>
                <div class="flex justify-between w-full max-w-[180px] text-xs text-gray-500 mt-1">
                    <span>住专</span>
                    <span>拽!</span>
                </div>
            </div>

            <!-- 爪 -->
            <div class="bg-amber-50 border-2 border-amber-200 py-4 px-6 mb-6 text-center rounded-xl">
                <p class="text-sm text-gray-600 mb-1">爪 爪拽:</p>
                <p id="winnerText" class="text-2xl font-bold text-[#800000]"></p>
            </div>

            <!-- 驻住拽  -->
            <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-[#800000]"></i>
                    拽 驻住拽 
                </h3>
                <p id="verdictText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <!-- 注砖 -->
            <div class="bg-red-50 rounded-xl p-6 border border-red-200">
                <h3 class="text-lg font-semibold text-red-700 mb-3 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    注砖 砖专
                </h3>
                <p id="punishmentText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <!-- 转专 -->
            <div class="mt-6 pt-4 border-t border-gray-200 text-sm text-gray-500 text-center">
                转专 专注: <span id="verdict-date"></span>
            </div>

            <!-- 驻转专 砖转祝 -->
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button id="downloadBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition border border-gray-300">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    专 转
                </button>
                <button id="whatsappBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition">
                    砖转祝 住驻
                </button>
                <button id="newVerdictBtn" class="flex-1 bg-[#800000] hover:bg-[#600000] text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    住住 砖
                </button>
            </div>
        </div>

        <!-- 驻专 -->
        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p> 住专 转  漏 驻住拽   爪专 专 </p>
        </footer>
    </div>

    <!--  转专转 -->
    <div id="authModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">爪专驻 爪</h2>
                <button id="closeAuthBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <p class="text-gray-500 text-sm mb-6 text-center">转专 砖 驻专 砖砖  </p>

            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button id="loginTab" class="flex-1 py-2 rounded-md font-semibold text-sm bg-white text-gray-900 shadow">转专转</button>
                <button id="registerTab" class="flex-1 py-2 rounded-md font-semibold text-sm text-gray-500">专砖</button>
            </div>

            <button id="googleSignInBtn" class="w-full bg-white border-2 border-gray-200 rounded-xl py-3 font-semibold text-gray-700 flex items-center justify-center gap-3 hover:border-amber-500 transition-all mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                砖 注 Google
            </button>

            <div class="flex items-center gap-4 my-4"><div class="h-px flex-1 bg-gray-200"></div><span class="text-gray-400 text-sm"></span><div class="h-px flex-1 bg-gray-200"></div></div>

            <form id="emailAuthForm" class="space-y-4">
                <input type="email" id="authEmail" placeholder="" class="input-field w-full p-3 text-gray-800" required>
                <input type="password" id="authPassword" placeholder="住住" class="input-field w-full p-3 text-gray-800" required minlength="6">
                <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl font-semibold"><span id="authSubmitText">转专转</span></button>
            </form>
            <p id="authError" class="hidden mt-4 text-center text-red-600 text-sm"></p>
        </div>
    </div>

    <!--  砖专 -->
    <div id="upgradeModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <button id="closeUpgradeBtn" class="float-left text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            <div class="clear-both">
                <div class="w-20 h-20 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="crown" class="w-10 h-10 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">专 拽专!</h2>
                <p class="text-gray-500 mb-6">砖转砖转 -4 驻住拽  </p>
                <button id="upgradeToAuthBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-4 rounded-xl font-bold text-lg">专砖 注砖 - !</button>
            </div>
        </div>
    </div>

    <!--  砖 -->
    <div id="errorModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-circle" class="w-8 h-8 text-red-600"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">驻住! 砖 砖转砖</h2>
            <p id="errorMessage" class="text-gray-500 mb-6"></p>
            <button id="closeErrorBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-xl font-semibold">转</button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDRR-PMlAz_hVzLQJ4jl37F3QDa_pxS830",
            authDomain: "royal-court-pettiness.firebaseapp.com",
            projectId: "royal-court-pettiness",
            storageBucket: "royal-court-pettiness.firebasestorage.app",
            messagingSenderId: "570213664438",
            appId: "1:570213664438:web:79a460121596a491c2c817"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.firebaseGoogleProvider = new GoogleAuthProvider();
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseIncrement = increment;

        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        // Gemini API
        var GEMINI_API_KEY = 'AIzaSyAzks62M8qyLefTZ2ovuPGmItfP26GcLIk';
    var GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro:generateContent';

        // State
        var currentUser = null;
        var userCredits = 4;
        var isPremium = false;
        var isAuthTabLogin = true;
        var lastVerdict = null;
        var selectedContext = 'work';

        var contextLabels = { couple: '', roommates: '砖转驻 专', family: '砖驻', work: '注' };

        // Wait for DOM
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            setupEventListeners();
        });

        // Wait for Firebase
        window.addEventListener('firebase-ready', function() {
            firebaseOnAuthStateChanged(firebaseAuth, handleAuthStateChange);
        });

        function setupEventListeners() {
            // Context buttons
            var contextBtns = document.querySelectorAll('.context-btn');
            contextBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    contextBtns.forEach(function(b) { b.classList.remove('selected'); });
                    btn.classList.add('selected');
                    selectedContext = btn.getAttribute('data-context');
                    lucide.createIcons();
                });
            });

            // Judge button
            document.getElementById('judge-button').addEventListener('click', handleJudgeClick);

            // Auth modal
            document.getElementById('loginBtn').addEventListener('click', function() {
                document.getElementById('authModal').classList.remove('hidden');
                lucide.createIcons();
            });
            document.getElementById('closeAuthBtn').addEventListener('click', function() {
                document.getElementById('authModal').classList.add('hidden');
            });

            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', function() {
                isAuthTabLogin = true;
                document.getElementById('loginTab').className = 'flex-1 py-2 rounded-md font-semibold text-sm bg-white text-gray-900 shadow';
                document.getElementById('registerTab').className = 'flex-1 py-2 rounded-md font-semibold text-sm text-gray-500';
                document.getElementById('authSubmitText').textContent = '转专转';
            });
            document.getElementById('registerTab').addEventListener('click', function() {
                isAuthTabLogin = false;
                document.getElementById('registerTab').className = 'flex-1 py-2 rounded-md font-semibold text-sm bg-white text-gray-900 shadow';
                document.getElementById('loginTab').className = 'flex-1 py-2 rounded-md font-semibold text-sm text-gray-500';
                document.getElementById('authSubmitText').textContent = '专砖';
            });

            // Google sign in
            document.getElementById('googleSignInBtn').addEventListener('click', async function() {
                try {
                    await firebaseSignInWithPopup(firebaseAuth, firebaseGoogleProvider);
                    document.getElementById('authModal').classList.add('hidden');
                } catch (e) {
                    document.getElementById('authError').textContent = '砖 转专转';
                    document.getElementById('authError').classList.remove('hidden');
                }
            });

            // Email auth form
            document.getElementById('emailAuthForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                var email = document.getElementById('authEmail').value;
                var pass = document.getElementById('authPassword').value;
                try {
                    if (isAuthTabLogin) {
                        await firebaseSignInWithEmailAndPassword(firebaseAuth, email, pass);
                    } else {
                        await firebaseCreateUserWithEmailAndPassword(firebaseAuth, email, pass);
                    }
                    document.getElementById('authModal').classList.add('hidden');
                } catch (err) {
                    var msg = '砖';
                    if (err.code === 'auth/invalid-email') msg = '  转拽';
                    if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') msg = '住住 砖';
                    if (err.code === 'auth/email-already-in-use') msg = ' 砖砖';
                    if (err.code === 'auth/user-not-found') msg = '砖转砖  爪';
                    document.getElementById('authError').textContent = msg;
                    document.getElementById('authError').classList.remove('hidden');
                }
            });

            // Sign out
            document.getElementById('signOutBtn').addEventListener('click', async function() {
                try { await firebaseSignOut(firebaseAuth); } catch (e) {}
            });

            // Upgrade modal
            document.getElementById('closeUpgradeBtn').addEventListener('click', function() {
                document.getElementById('upgradeModal').classList.add('hidden');
            });
            document.getElementById('upgradeToAuthBtn').addEventListener('click', function() {
                document.getElementById('upgradeModal').classList.add('hidden');
                document.getElementById('authModal').classList.remove('hidden');
                lucide.createIcons();
            });

            // Error modal
            document.getElementById('closeErrorBtn').addEventListener('click', function() {
                document.getElementById('errorModal').classList.add('hidden');
            });

            // Share buttons
            document.getElementById('downloadBtn').addEventListener('click', downloadAsImage);
            document.getElementById('whatsappBtn').addEventListener('click', shareToWhatsApp);
            document.getElementById('newVerdictBtn').addEventListener('click', newVerdict);

            // Close modals on backdrop click
            document.getElementById('authModal').addEventListener('click', function(e) {
                if (e.target === this) this.classList.add('hidden');
            });
            document.getElementById('upgradeModal').addEventListener('click', function(e) {
                if (e.target === this) this.classList.add('hidden');
            });
            document.getElementById('errorModal').addEventListener('click', function(e) {
                if (e.target === this) this.classList.add('hidden');
            });
        }

        async function handleAuthStateChange(user) {
            currentUser = user;
            if (user) {
                isPremium = !user.isAnonymous;
                if (isPremium) {
                    showPremiumUI();
                } else {
                    await checkUsageLimits(user.uid);
                    showFreeUI();
                }
            } else {
                try {
                    await firebaseSignInAnonymously(firebaseAuth);
                } catch (e) {
                    console.error(e);
                }
            }
        }

        async function checkUsageLimits(uid) {
            try {
                var ref = firebaseDoc(firebaseDb, 'user_limits', uid);
                var snap = await firebaseGetDoc(ref);
                if (snap.exists()) {
                    userCredits = Math.max(0, 4 - (snap.data().count || 0));
                } else {
                    await firebaseSetDoc(ref, { count: 0 });
                    userCredits = 4;
                }
                updateCreditsDisplay();
            } catch (e) {
                console.error(e);
                userCredits = 4;
                updateCreditsDisplay();
            }
        }

        async function incrementUsage(uid) {
            try {
                await firebaseUpdateDoc(firebaseDoc(firebaseDb, 'user_limits', uid), { count: firebaseIncrement(1) });
                userCredits--;
                updateCreditsDisplay();
            } catch (e) {
                console.error(e);
            }
        }

        function showPremiumUI() {
            document.getElementById('creditsDisplay').classList.add('hidden');
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('premiumBadge').classList.remove('hidden');
            lucide.createIcons();
        }

        function showFreeUI() {
            document.getElementById('creditsDisplay').classList.remove('hidden');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('premiumBadge').classList.add('hidden');
            updateCreditsDisplay();
            lucide.createIcons();
        }

        function updateCreditsDisplay() {
            var c = document.getElementById('creditsCount');
            c.textContent = userCredits + '/4';
            c.className = userCredits <= 1 ? 'text-red-600 font-bold' : 'text-amber-600 font-bold';
        }

        function showError(msg) {
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorModal').classList.remove('hidden');
            lucide.createIcons();
        }

        async function handleJudgeClick() {
            if (!isPremium && userCredits <= 0) {
                document.getElementById('upgradeModal').classList.remove('hidden');
                lucide.createIcons();
                return;
            }

            var sideA = document.getElementById('claim-a').value.trim();
            var sideB = document.getElementById('claim-b').value.trim();

            if (!sideA || !sideB || sideA.length < 10 || sideB.length < 10) {
                showError('  转 砖 爪 (驻转 10 转  爪)');
                return;
            }

            document.getElementById('loading-area').classList.remove('hidden');
            document.getElementById('judge-button').disabled = true;

            try {
                var verdict = await getVerdict(selectedContext, sideA, sideB);
                if (!isPremium && currentUser) {
                    await incrementUsage(currentUser.uid);
                }
                displayVerdict(verdict);
            } catch (e) {
                console.error(e);
                showError('砖驻 转拽 注 转. 住 砖.');
            }

            document.getElementById('loading-area').classList.add('hidden');
            document.getElementById('judge-button').disabled = false;
        }

        async function getVerdict(context, sideA, sideB) {
            var contextHebrew = contextLabels[context] || '';

            var prompt = '转 砖驻 转 住专拽住 爪拽 转  拽转. 转驻拽 砖驻 住住 拽 爪专 专住转.\n\n' +
                '拽砖专: ' + contextHebrew + '\n\n' +
                '爪  注: ' + sideA + '\n\n' +
                '爪  注: ' + sideB + '\n\n' +
                '专 转砖 驻专 JSON  ( markdown,  backticks, 专拽 JSON 专):\n' +
                '{"winner": "爪 "  "爪 "  "砖 爪拽"  "砖 注", "pettyScore": 住驻专 0-100, "verdict": "驻住拽  住专拽住 爪拽 注专转 3-5 砖驻", "punishment": "注砖 爪专转 爪拽 2-3 砖驻"}\n\n' +
                ' 住专拽住 爪拽. 转住 驻专 住驻爪驻. 注砖 爪专 转 爪专转.';

            var response = await fetch(GEMINI_API_URL + '?key=' + GEMINI_API_KEY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.9, maxOutputTokens: 1024 }
                })
            });

            if (!response.ok) {
                throw new Error('API request failed: ' + response.status);
            }

            var data = await response.json();
            var txt = data.candidates[0].content.parts[0].text.trim();

            // Remove markdown code blocks if present
            if (txt.startsWith('```')) {
                txt = txt.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
            }

            return JSON.parse(txt);
        }

        function displayVerdict(v) {
            lastVerdict = v;
            document.getElementById('verdict-output').classList.remove('hidden');
            document.getElementById('winnerText').textContent = v.winner;
            document.getElementById('verdictText').textContent = v.verdict;
            document.getElementById('punishmentText').textContent = v.punishment;
            document.getElementById('verdict-date').textContent = new Date().toLocaleDateString('he-IL', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            animateGauge(v.pettyScore);
            lucide.createIcons();
            document.getElementById('verdict-output').scrollIntoView({ behavior: 'smooth' });
        }

        function animateGauge(score) {
            var needle = document.getElementById('gaugeNeedle');
            var scoreEl = document.getElementById('scoreValue');
            var rotation = -90 + (score * 1.8);
            needle.style.transform = 'translateX(-50%) rotate(' + rotation + 'deg)';

            var curr = 0;
            var interval = setInterval(function() {
                curr++;
                scoreEl.textContent = curr;
                if (curr >= score) clearInterval(interval);
            }, 15);
        }

        function newVerdict() {
            document.getElementById('claim-a').value = '';
            document.getElementById('claim-b').value = '';
            document.getElementById('verdict-output').classList.add('hidden');
            document.getElementById('gaugeNeedle').style.transform = 'translateX(-50%) rotate(-90deg)';
            document.getElementById('scoreValue').textContent = '0';
            lastVerdict = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function downloadAsImage() {
            try {
                var canvas = await html2canvas(document.getElementById('verdict-output'), {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                var link = document.createElement('a');
                link.download = '驻住拽-.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                showError('砖 爪专转 转');
            }
        }

        function shareToWhatsApp() {
            if (!lastVerdict) return;
            var txt = '锔 *驻住拽  " 住专 转 "*\n\n' +
                ' 爪 爪拽: ' + lastVerdict.winner + '\n' +
                ' 爪 拽转: ' + lastVerdict.pettyScore + '/100\n\n' +
                ' ' + lastVerdict.verdict + '\n\n' +
                '锔 注砖: ' + lastVerdict.punishment;
            window.open('https://wa.me/?text=' + encodeURIComponent(txt), '_blank');
        }
    </script>
</body>
</html>
